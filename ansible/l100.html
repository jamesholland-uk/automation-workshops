<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>1. Ansible L100 &mdash; Automation Workshops  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/clipboard.min.js"></script>
        <script src="../_static/copybutton.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="2. Ansible L200" href="l200.html" />
    <link rel="prev" title="3. XML API L300" href="../xmlapi/l300.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> Automation Workshops
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">PAN-OS API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../xmlapi/l100.html">1. XML API L100</a></li>
<li class="toctree-l1"><a class="reference internal" href="../xmlapi/l200.html">2. XML API L200</a></li>
<li class="toctree-l1"><a class="reference internal" href="../xmlapi/l300.html">3. XML API L300</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">PAN-OS Ansible</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">1. Ansible L100</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#ansible-pre-flight-checks">1.1. Ansible pre-flight checks</a></li>
<li class="toctree-l2"><a class="reference internal" href="#download-ansible-playbooks">1.2. Download Ansible playbooks</a></li>
<li class="toctree-l2"><a class="reference internal" href="#setup-the-inventory">1.3. Setup the inventory</a></li>
<li class="toctree-l2"><a class="reference internal" href="#prepare-the-firewall-credentials">1.4. Prepare the firewall credentials</a></li>
<li class="toctree-l2"><a class="reference internal" href="#run-our-first-ansible-playbook">1.5. Run our first Ansible playbook</a></li>
<li class="toctree-l2"><a class="reference internal" href="#ansible-playbook-2-are-you-ready">1.6. Ansible Playbook 2 - Are you ready?</a></li>
<li class="toctree-l2"><a class="reference internal" href="#ansible-playbook-3-more-firewall-information">1.7. Ansible Playbook 3 - More firewall information</a></li>
<li class="toctree-l2"><a class="reference internal" href="#ansible-playbook-4-config-backup-export">1.8. Ansible Playbook 4 - Config backup/export</a></li>
<li class="toctree-l2"><a class="reference internal" href="#firewall-configuration-tasks">1.9. Firewall configuration tasks</a></li>
<li class="toctree-l2"><a class="reference internal" href="#modify-a-playbook">1.10. Modify a playbook</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="l200.html">2. Ansible L200</a></li>
<li class="toctree-l1"><a class="reference internal" href="l300.html">3. Ansible L300</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">PAN-OS Terraform</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../terraform/l100.html">1. Terraform L100</a></li>
<li class="toctree-l1"><a class="reference internal" href="../terraform/l200.html">2. Terraform L200</a></li>
<li class="toctree-l1"><a class="reference internal" href="../terraform/l300.html">3. Terraform L300</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Automation Workshops</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li><span class="section-number">1. </span>Ansible L100</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/ansible/l100.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="ansible-l100">
<h1><span class="section-number">1. </span>Ansible L100<a class="headerlink" href="#ansible-l100" title="Permalink to this headline"></a></h1>
<p>Hands-on tasks for this workshop will be using Ansible playbooks against a PAN-OS firewall, from your command-line environment. For each task, you can use the copy button to take the command into the clipboard, but ensure you replace the {{ variables in braces }} with your own values.</p>
<p>Assumptions: A host with the following installed: curl, git, <a class="reference external" href="https://www.python.org/downloads">Python 3</a>, <a class="reference external" href="https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html#installing-and-upgrading-ansible-with-pip">Ansible</a>, <a class="reference external" href="https://github.com/PaloAltoNetworks/pan-os-python">PAN-OS-Python</a>, <a class="reference external" href="https://github.com/PaloAltoNetworks/pan-os-ansible">PAN-OS Ansible Collection</a>, and all prerequisite requirements for those items. Plus some form of text editor on your host. And, access to a PAN-OS next-generation firewall from your host.</p>
<dl class="simple">
<dt>Note:</dt><dd><ul class="simple">
<li><p>Where text is enclosed in {{ double braces }}, replace the text AND braces with the relevant value for your environment.</p></li>
<li><p>Commands you could/should execute are denoted with <code class="docutils literal notranslate"><span class="pre">$</span></code> at the start, and have copy buttons; other text boxes show expected outputs.</p></li>
<li><p>You may wish to have a text editor open on your machine, to amend copied commands before psting them into the host’s CLI.</p></li>
</ul>
</dd>
</dl>
<section id="ansible-pre-flight-checks">
<h2><span class="section-number">1.1. </span>Ansible pre-flight checks<a class="headerlink" href="#ansible-pre-flight-checks" title="Permalink to this headline"></a></h2>
<p>First let’s check that Ansible is installed on our host.</p>
<div class="copy-button highlight-default notranslate"><div class="highlight"><pre><span></span>$ ansible-playbook --version
</pre></div>
</div>
<p>The output should look something like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ansible</span><span class="o">-</span><span class="n">playbook</span> <span class="p">[</span><span class="n">core</span> <span class="mf">2.11.5</span><span class="p">]</span>
    <span class="n">config</span> <span class="n">file</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">configured</span> <span class="n">module</span> <span class="n">search</span> <span class="n">path</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;/Users/jholland/.ansible/plugins/modules&#39;</span><span class="p">,</span> <span class="s1">&#39;/usr/share/ansible/plugins/modules&#39;</span><span class="p">]</span>
    <span class="n">ansible</span> <span class="n">python</span> <span class="n">module</span> <span class="n">location</span> <span class="o">=</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.9</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">ansible</span>
    <span class="n">ansible</span> <span class="n">collection</span> <span class="n">location</span> <span class="o">=</span> <span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">jholland</span><span class="o">/.</span><span class="n">ansible</span><span class="o">/</span><span class="n">collections</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">ansible</span><span class="o">/</span><span class="n">collections</span>
    <span class="n">executable</span> <span class="n">location</span> <span class="o">=</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">ansible</span><span class="o">-</span><span class="n">playbook</span>
    <span class="n">python</span> <span class="n">version</span> <span class="o">=</span> <span class="mf">3.9.7</span> <span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="n">Oct</span> <span class="mi">13</span> <span class="mi">2021</span><span class="p">,</span> <span class="mi">06</span><span class="p">:</span><span class="mi">45</span><span class="p">:</span><span class="mi">31</span><span class="p">)</span> <span class="p">[</span><span class="n">Clang</span> <span class="mf">13.0.0</span> <span class="p">(</span><span class="n">clang</span><span class="o">-</span><span class="mf">1300.0.29.3</span><span class="p">)]</span>
    <span class="n">jinja</span> <span class="n">version</span> <span class="o">=</span> <span class="mf">2.11.3</span>
    <span class="n">libyaml</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</div>
<p>Now let’s install the PAN-OS Collection:</p>
<div class="copy-button highlight-default notranslate"><div class="highlight"><pre><span></span>$ ansible-galaxy collection install paloaltonetworks.panos
</pre></div>
</div>
<p>We can check the Collection is present using this command:</p>
<div class="copy-button highlight-default notranslate"><div class="highlight"><pre><span></span>$ ansible-doc --list | grep paloaltonetworks.panos
</pre></div>
</div>
<p>The output should list all the modules in the PAN-OS Collection, the end of the list should look something like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">paloaltonetworks</span><span class="o">.</span><span class="n">panos</span><span class="o">.</span><span class="n">panos_virtual_router</span>                           <span class="n">Confi</span><span class="o">...</span>
<span class="n">paloaltonetworks</span><span class="o">.</span><span class="n">panos</span><span class="o">.</span><span class="n">panos_virtual_router_facts</span>                     <span class="n">Retri</span><span class="o">...</span>
<span class="n">paloaltonetworks</span><span class="o">.</span><span class="n">panos</span><span class="o">.</span><span class="n">panos_virtual_wire</span>                             <span class="n">Confi</span><span class="o">...</span>
<span class="n">paloaltonetworks</span><span class="o">.</span><span class="n">panos</span><span class="o">.</span><span class="n">panos_vlan</span>                                     <span class="n">Confi</span><span class="o">...</span>
<span class="n">paloaltonetworks</span><span class="o">.</span><span class="n">panos</span><span class="o">.</span><span class="n">panos_vlan_interface</span>                           <span class="n">confi</span><span class="o">...</span>
<span class="n">paloaltonetworks</span><span class="o">.</span><span class="n">panos</span><span class="o">.</span><span class="n">panos_vm_auth_key</span>                              <span class="n">Creat</span><span class="o">...</span>
<span class="n">paloaltonetworks</span><span class="o">.</span><span class="n">panos</span><span class="o">.</span><span class="n">panos_zone</span>                                     <span class="n">confi</span><span class="o">...</span>
<span class="n">paloaltonetworks</span><span class="o">.</span><span class="n">panos</span><span class="o">.</span><span class="n">panos_zone_facts</span>                               <span class="n">Retri</span><span class="o">...</span>
</pre></div>
</div>
</section>
<section id="download-ansible-playbooks">
<h2><span class="section-number">1.2. </span>Download Ansible playbooks<a class="headerlink" href="#download-ansible-playbooks" title="Permalink to this headline"></a></h2>
<p>In this workshop, we’re going to be using some existing playbooks. We’ll use git to download the playbooks from a repository…</p>
<div class="copy-button highlight-default notranslate"><div class="highlight"><pre><span></span>$ git clone https://github.com/jamesholland-uk/automation-workshops.git
</pre></div>
</div>
<p>…then move into the Ansible directory</p>
<div class="copy-button highlight-default notranslate"><div class="highlight"><pre><span></span>$ cd automation-workshops/ansible
</pre></div>
</div>
</section>
<section id="setup-the-inventory">
<h2><span class="section-number">1.3. </span>Setup the inventory<a class="headerlink" href="#setup-the-inventory" title="Permalink to this headline"></a></h2>
<p>Ansible needs to know the details for the hosts against which it should execute playbooks. This <code class="docutils literal notranslate"><span class="pre">inventory</span></code> can take many formats and locations, and for this workshop we will use the inventory format from the example playbooks repository.</p>
<p>In the ansible-playbooks directory, the <code class="docutils literal notranslate"><span class="pre">inventory</span></code> file contains a list of available hosts for us to run playbooks against:</p>
<div class="copy-button highlight-default notranslate"><div class="highlight"><pre><span></span>$ cat inventory
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">firewall</span>
<span class="n">ha_pair</span>

<span class="n">panorama</span>
<span class="n">panorama_ha_pair</span>
</pre></div>
</div>
<p>All our example playbooks begin with a reference to a default target host from our <code class="docutils literal notranslate"><span class="pre">inventory</span></code> file, which is <code class="docutils literal notranslate"><span class="pre">firewall</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">hosts</span><span class="p">:</span> <span class="s1">&#39;{{ target | default(&quot;firewall&quot;) }}&#39;</span>
</pre></div>
</div>
<p>We provide the <code class="docutils literal notranslate"><span class="pre">firewall</span></code>’s IP address in the <code class="docutils literal notranslate"><span class="pre">host_vars/firewall.yml</span></code> file:</p>
<div class="copy-button highlight-default notranslate"><div class="highlight"><pre><span></span>$ cat host_vars/firewall.yml
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">---</span>
<span class="n">ip_address</span><span class="p">:</span> <span class="s1">&#39;192.168.55.10&#39;</span>
</pre></div>
</div>
<p>Change the IP address in this file to match your firewalls’s management IP address, either use your preferred text editor to replace the IP address in <code class="docutils literal notranslate"><span class="pre">host_vars/firewall.yml</span></code>, or use this command:</p>
<div class="copy-button highlight-default notranslate"><div class="highlight"><pre><span></span>$ cat &gt; host_vars/firewall.yml &lt;&lt;EOL
---
ip_address: &#39;{{ your firewall management IP }}&#39;
EOL
</pre></div>
</div>
<p>Re-check the <code class="docutils literal notranslate"><span class="pre">host_vars/firewall.yml</span></code> file and ensure it now contains your firewall’s IP address:</p>
<div class="copy-button highlight-default notranslate"><div class="highlight"><pre><span></span>$ cat host_vars/firewall.yml
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">---</span>
<span class="n">ip_address</span><span class="p">:</span> <span class="s1">&#39;{{ your firewall management IP }}&#39;</span>
</pre></div>
</div>
</section>
<section id="prepare-the-firewall-credentials">
<h2><span class="section-number">1.4. </span>Prepare the firewall credentials<a class="headerlink" href="#prepare-the-firewall-credentials" title="Permalink to this headline"></a></h2>
<p>Before you can execute any Ansible playbooks, you need to be able to login to the firewall. We will store the admin username and admin password as variables.</p>
<div class="copy-button highlight-default notranslate"><div class="highlight"><pre><span></span>$ export panos_username={{ your-admin-username }}
</pre></div>
</div>
<div class="copy-button highlight-default notranslate"><div class="highlight"><pre><span></span>$ export panos_password={{ your-admin-password }}
</pre></div>
</div>
<p>In production environments, credentials should be stored, accessed and used securely, per the security policy and compliance requirements. Today, in this enviornment, we will use these credentials stored in variables for executing Ansible playbooks.</p>
</section>
<section id="run-our-first-ansible-playbook">
<h2><span class="section-number">1.5. </span>Run our first Ansible playbook<a class="headerlink" href="#run-our-first-ansible-playbook" title="Permalink to this headline"></a></h2>
<p>Our first Ansible playbook will gather system information from the firewall. Data gathering or read-only tasks are good candidiates for anyone starting out in automation. Execute the <a class="reference external" href="https://github.com/jamesholland-uk/automation-workshops/blob/main/ansible/system_info.yml">system-info playbook</a> using the command below.</p>
<div class="copy-button highlight-default notranslate"><div class="highlight"><pre><span></span>$ ansible-playbook -i inventory system_info.yml --extra-vars &quot;username=$panos_username password=$panos_password&quot;
</pre></div>
</div>
<p>Notice that we execute the <code class="docutils literal notranslate"><span class="pre">ansible-playbook</span></code> command, pass in the previously mentioned inventory using <code class="docutils literal notranslate"><span class="pre">-i</span> <span class="pre">inventory</span></code>, then specify the name of the playbook we want to run, <code class="docutils literal notranslate"><span class="pre">system_info.yml</span></code>, and finally pass in the firewall credentials with <code class="docutils literal notranslate"><span class="pre">--extra-vars</span> <span class="pre">&quot;username=$panos_username</span> <span class="pre">password=$panos_password&quot;</span></code>.</p>
<p>Let’s look at the playbook we executed:</p>
<div class="copy-button highlight-default notranslate"><div class="highlight"><pre><span></span>$ cat system_info.yml
</pre></div>
</div>
<p>Breaking down the component parts of the playbook:</p>
<p>After the “comments” which are the lines starting with # characters, first we see the default host is <code class="docutils literal notranslate"><span class="pre">firewall</span></code>, from the previously mentioned inventory. Our connection type is <code class="docutils literal notranslate"><span class="pre">local</span></code> (we don’t use Ansible in a traditional method, because executing code on PAN-OS would work and would not be secure; instead we execute commands locally on our host, and those commands call the PAN-OS XML API).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">hosts</span><span class="p">:</span> <span class="s1">&#39;{{ target | default(&quot;firewall&quot;) }}&#39;</span>
  <span class="n">connection</span><span class="p">:</span> <span class="n">local</span>
</pre></div>
</div>
<p>Second we see a section of variables. We get the <code class="docutils literal notranslate"><span class="pre">ip_address</span></code> of the firewall from the previously mentioned inventory, and we get the username and password from the <code class="docutils literal notranslate"><span class="pre">export</span></code> commands we typed into the CLI. We don’t use the api_key in this instance.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">vars</span><span class="p">:</span>
  <span class="n">device</span><span class="p">:</span>
    <span class="n">ip_address</span><span class="p">:</span> <span class="s1">&#39;{{ ip_address }}&#39;</span>
    <span class="n">username</span><span class="p">:</span> <span class="s1">&#39;{{ username | default(omit) }}&#39;</span>
    <span class="n">password</span><span class="p">:</span> <span class="s1">&#39;{{ password | default(omit) }}&#39;</span>
    <span class="n">api_key</span><span class="p">:</span> <span class="s1">&#39;{{ api_key | default(omit) }}&#39;</span>
</pre></div>
</div>
<p>Now we get to our <code class="docutils literal notranslate"><span class="pre">tasks</span></code>, the jobs we want Ansible to do for us. We are just data gathering, so our first task is to gather <code class="docutils literal notranslate"><span class="pre">facts</span></code>, which in Ansible unsurprisingly are information about the target system. The second task uses the built-in <code class="docutils literal notranslate"><span class="pre">debug</span></code> to display a series of useful system information.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tasks</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Gather</span> <span class="n">facts</span> <span class="k">for</span> <span class="n">device</span>
    <span class="n">paloaltonetworks</span><span class="o">.</span><span class="n">panos</span><span class="o">.</span><span class="n">panos_facts</span><span class="p">:</span>
      <span class="n">provider</span><span class="p">:</span> <span class="s2">&quot;{{ device }}&quot;</span>

  <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Display</span> <span class="n">model</span><span class="p">,</span> <span class="n">PAN</span><span class="o">-</span><span class="n">OS</span> <span class="n">version</span>
    <span class="n">debug</span><span class="p">:</span>
      <span class="n">msg</span><span class="p">:</span>
        <span class="o">-</span> <span class="s2">&quot;Hostname: {{ ansible_facts[&#39;net_hostname&#39;] }}&quot;</span>
        <span class="o">-</span> <span class="s2">&quot;Serial: {{ ansible_facts[&#39;net_serial&#39;] }}&quot;</span>
        <span class="o">.</span>
        <span class="o">.</span>
        <span class="o">.</span>
</pre></div>
</div>
<p>The output should look something like this, specifically the highlighted lines showing the information from our firewall:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PLAY</span> <span class="p">[</span><span class="n">firewall</span><span class="p">]</span> <span class="o">***************************************************************************************************************************</span>

<span class="n">TASK</span> <span class="p">[</span><span class="n">Gathering</span> <span class="n">Facts</span><span class="p">]</span> <span class="o">********************************************************************************************************************</span>
<span class="n">ok</span><span class="p">:</span> <span class="p">[</span><span class="n">firewall</span><span class="p">]</span>

<span class="n">TASK</span> <span class="p">[</span><span class="n">Gather</span> <span class="n">facts</span> <span class="k">for</span> <span class="n">device</span><span class="p">]</span> <span class="o">************************************************************************************************************</span>
<span class="n">ok</span><span class="p">:</span> <span class="p">[</span><span class="n">firewall</span><span class="p">]</span>

<span class="n">TASK</span> <span class="p">[</span><span class="n">Display</span> <span class="n">model</span><span class="p">,</span> <span class="n">PAN</span><span class="o">-</span><span class="n">OS</span> <span class="n">version</span><span class="p">]</span> <span class="o">******************************************************************************************************</span>
<span class="n">ok</span><span class="p">:</span> <span class="p">[</span><span class="n">firewall</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="s2">&quot;msg&quot;</span><span class="p">:</span> <span class="p">[</span>
<span class="hll">                <span class="s2">&quot;Hostname: vm-series-01&quot;</span><span class="p">,</span>
</span><span class="hll">                <span class="s2">&quot;Serial: 01234567890&quot;</span><span class="p">,</span>
</span><span class="hll">                <span class="s2">&quot;Model: PA-VM&quot;</span><span class="p">,</span>
</span><span class="hll">                <span class="s2">&quot;Version: 10.1.3&quot;</span><span class="p">,</span>
</span><span class="hll">                <span class="s2">&quot;Uptime: 46 days, 3:03:16&quot;</span><span class="p">,</span>
</span><span class="hll">                <span class="s2">&quot;HA Enabled: True&quot;</span><span class="p">,</span>
</span><span class="hll">                <span class="s2">&quot;HA Type: Active-Passive&quot;</span><span class="p">,</span>
</span><span class="hll">                <span class="s2">&quot;HA Status: active&quot;</span><span class="p">,</span>
</span><span class="hll">                <span class="s2">&quot;Multi-VSYS: off&quot;</span><span class="p">,</span>
</span><span class="hll">                <span class="s2">&quot;1546 out of 256000 sessions in use&quot;</span>
</span>        <span class="p">]</span>
<span class="p">}</span>

<span class="n">PLAY</span> <span class="n">RECAP</span> <span class="o">********************************************************************************************************************************</span>
<span class="n">firewall</span>                   <span class="p">:</span> <span class="n">ok</span><span class="o">=</span><span class="mi">3</span>    <span class="n">changed</span><span class="o">=</span><span class="mi">0</span>    <span class="n">unreachable</span><span class="o">=</span><span class="mi">0</span>    <span class="n">failed</span><span class="o">=</span><span class="mi">0</span>    <span class="n">skipped</span><span class="o">=</span><span class="mi">0</span>    <span class="n">rescued</span><span class="o">=</span><span class="mi">0</span>    <span class="n">ignored</span><span class="o">=</span><span class="mi">0</span>
</pre></div>
</div>
</section>
<section id="ansible-playbook-2-are-you-ready">
<h2><span class="section-number">1.6. </span>Ansible Playbook 2 - Are you ready?<a class="headerlink" href="#ansible-playbook-2-are-you-ready" title="Permalink to this headline"></a></h2>
<p>Our second playbook executes the <code class="docutils literal notranslate"><span class="pre">show</span> <span class="pre">chassis-ready</span></code> command. This is useful to ensure the firewall is ready to accept further operations such as configuration changes, software downloads and updgrades, and more. The <a class="reference external" href="https://github.com/jamesholland-uk/automation-workshops/blob/main/ansible/check_ready.yml">playbook</a> runs the <code class="docutils literal notranslate"><span class="pre">show</span> <span class="pre">chassis-ready</span></code> command on a loop until it gets the positive <code class="docutils literal notranslate"><span class="pre">yes</span></code> result that the firewall is ready. Run the playbook using the following:</p>
<div class="copy-button highlight-default notranslate"><div class="highlight"><pre><span></span>$ ansible-playbook -i inventory check_ready.yml --extra-vars &quot;username=$panos_username password=$panos_password&quot;
</pre></div>
</div>
<p>The playbook has the same opening sections for the hosts, conection, and variables. The tasks section is different, where this time we use a single task ( using`panos_op` to run <cite>show chassis-ready</cite>), then use Ansible’s <cite>retries</cite> and <cite>until</cite> to create the loop which waits for the firewall to be ready by virtue of the <cite>yes</cite> response. It will retry 50 times, trying every 30 seconds, until the output from the <cite>show chassis-ready</cite> is <cite>yes</cite>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tasks</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Check</span> <span class="n">to</span> <span class="n">see</span> <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="n">ready</span>
    <span class="n">paloaltonetworks</span><span class="o">.</span><span class="n">panos</span><span class="o">.</span><span class="n">panos_op</span><span class="p">:</span>
      <span class="n">provider</span><span class="p">:</span> <span class="s1">&#39;{{ device }}&#39;</span>
      <span class="n">cmd</span><span class="p">:</span> <span class="s1">&#39;show chassis-ready&#39;</span>
    <span class="n">changed_when</span><span class="p">:</span> <span class="n">false</span>
    <span class="n">register</span><span class="p">:</span> <span class="n">result</span>
    <span class="n">until</span><span class="p">:</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">failed</span> <span class="ow">and</span> <span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">stdout</span> <span class="o">|</span> <span class="n">from_json</span><span class="p">)</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">result</span> <span class="o">==</span> <span class="s1">&#39;yes&#39;</span>
    <span class="n">retries</span><span class="p">:</span> <span class="mi">50</span>
    <span class="n">delay</span><span class="p">:</span> <span class="mi">30</span>
</pre></div>
</div>
<p>The sucessful output should look something like this, specifically the highlighted line showing the “ok” response to checking if the firewall is ready:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PLAY</span> <span class="p">[</span><span class="n">firewall</span><span class="p">]</span> <span class="o">**************************************************************************************************</span>

<span class="n">TASK</span> <span class="p">[</span><span class="n">Gathering</span> <span class="n">Facts</span><span class="p">]</span> <span class="o">*******************************************************************************************</span>
<span class="n">ok</span><span class="p">:</span> <span class="p">[</span><span class="n">firewall</span><span class="p">]</span>

<span class="n">TASK</span> <span class="p">[</span><span class="n">Check</span> <span class="n">to</span> <span class="n">see</span> <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="n">ready</span><span class="p">]</span> <span class="o">***************************************************************************</span>
<span class="hll"><span class="n">ok</span><span class="p">:</span> <span class="p">[</span><span class="n">firewall</span><span class="p">]</span>
</span>
<span class="n">PLAY</span> <span class="n">RECAP</span> <span class="o">*******************************************************************************************************</span>
<span class="n">firewall</span>                   <span class="p">:</span> <span class="n">ok</span><span class="o">=</span><span class="mi">2</span>    <span class="n">changed</span><span class="o">=</span><span class="mi">0</span>    <span class="n">unreachable</span><span class="o">=</span><span class="mi">0</span>    <span class="n">failed</span><span class="o">=</span><span class="mi">0</span>    <span class="n">skipped</span><span class="o">=</span><span class="mi">0</span>    <span class="n">rescued</span><span class="o">=</span><span class="mi">0</span>    <span class="n">ignored</span><span class="o">=</span><span class="mi">0</span>
</pre></div>
</div>
<p>If the firewall is booting up, or not reachable, you would receieve failure messages, and the loop of checking would kick in, like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PLAY</span> <span class="p">[</span><span class="n">firewall</span><span class="p">]</span> <span class="o">**************************************************************************************************</span>

<span class="n">TASK</span> <span class="p">[</span><span class="n">Gathering</span> <span class="n">Facts</span><span class="p">]</span> <span class="o">*******************************************************************************************</span>
<span class="n">ok</span><span class="p">:</span> <span class="p">[</span><span class="n">firewall</span><span class="p">]</span>

<span class="n">TASK</span> <span class="p">[</span><span class="n">Check</span> <span class="n">to</span> <span class="n">see</span> <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="n">ready</span><span class="p">]</span> <span class="o">***************************************************************************</span>
<span class="hll"><span class="n">FAILED</span> <span class="o">-</span> <span class="n">RETRYING</span><span class="p">:</span> <span class="n">Check</span> <span class="n">to</span> <span class="n">see</span> <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="n">ready</span> <span class="p">(</span><span class="mi">50</span> <span class="n">retries</span> <span class="n">left</span><span class="p">)</span><span class="o">.</span>
</span><span class="hll"><span class="n">FAILED</span> <span class="o">-</span> <span class="n">RETRYING</span><span class="p">:</span> <span class="n">Check</span> <span class="n">to</span> <span class="n">see</span> <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="n">ready</span> <span class="p">(</span><span class="mi">49</span> <span class="n">retries</span> <span class="n">left</span><span class="p">)</span><span class="o">.</span>
</span></pre></div>
</div>
</section>
<section id="ansible-playbook-3-more-firewall-information">
<h2><span class="section-number">1.7. </span>Ansible Playbook 3 - More firewall information<a class="headerlink" href="#ansible-playbook-3-more-firewall-information" title="Permalink to this headline"></a></h2>
<p>The third <a class="reference external" href="https://github.com/jamesholland-uk/automation-workshops/blob/main/ansible/some_more_info.yml">example playbook</a> again gathers <code class="docutils literal notranslate"><span class="pre">facts</span></code> in order to display information about the running configiration and state of the firewall. This could be useful information on its own, but could also be used to feed into other tasks later on. Run the playbook using the following:</p>
<div class="copy-button highlight-default notranslate"><div class="highlight"><pre><span></span>$ ansible-playbook -i inventory some_more_info.yml --extra-vars &quot;username=$panos_username password=$panos_password&quot;
</pre></div>
</div>
<p>The playbook should provide information about the security policy rules, the network interfaces, and the route table.</p>
</section>
<section id="ansible-playbook-4-config-backup-export">
<h2><span class="section-number">1.8. </span>Ansible Playbook 4 - Config backup/export<a class="headerlink" href="#ansible-playbook-4-config-backup-export" title="Permalink to this headline"></a></h2>
<p>The next <a class="reference external" href="https://github.com/jamesholland-uk/automation-workshops/blob/main/ansible/backup_config.yml">Ansible playbook</a> uses the <a class="reference external" href="https://paloaltonetworks.github.io/pan-os-ansible/modules/panos_export.html">panos_export module</a> to export the running config to a local file. Run the playbook using the following:</p>
<div class="copy-button highlight-default notranslate"><div class="highlight"><pre><span></span>$ ansible-playbook -i inventory backup_config.yml --extra-vars &quot;username=$panos_username password=$panos_password&quot;
</pre></div>
</div>
<p>Once executed, you should be able to see the exported config file on yours host:</p>
<div class="copy-button highlight-default notranslate"><div class="highlight"><pre><span></span>$ cat running-config.xml
</pre></div>
</div>
</section>
<section id="firewall-configuration-tasks">
<h2><span class="section-number">1.9. </span>Firewall configuration tasks<a class="headerlink" href="#firewall-configuration-tasks" title="Permalink to this headline"></a></h2>
<p>Our next playbook is focused on configuration tasks, and this playbook configures all the required items for a basic firewall setup.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="n">tasks</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">name</span><span class="p">:</span>

<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
</pre></div>
</div>
<div class="copy-button highlight-default notranslate"><div class="highlight"><pre><span></span>$ ansible-playbook -i inventory simple_config.yml --extra-vars &quot;username=$panos_username password=$panos_password&quot;
</pre></div>
</div>
</section>
<section id="modify-a-playbook">
<h2><span class="section-number">1.10. </span>Modify a playbook<a class="headerlink" href="#modify-a-playbook" title="Permalink to this headline"></a></h2>
<p>The <a class="reference external" href="https://paloaltonetworks.github.io/pan-os-ansible/modules/panos_op.html">panos_op module</a> is very useful within playbooks for gathering information and executing operational commands like gatering system information, software upgrades, content downloads, and more. It was used in the second playbook, check_ready.yml, to run the <code class="docutils literal notranslate"><span class="pre">show</span> <span class="pre">chassis-ready</span></code> command.</p>
<p>Choose one (or more) of the following operational commands to run with Ansible.</p>
<blockquote>
<div><ul class="simple">
<li><p>show clock</p></li>
<li><p>show admins all</p></li>
<li><p>show system disk-space</p></li>
</ul>
</div></blockquote>
<p>Edit the <code class="docutils literal notranslate"><span class="pre">template.yml</span></code> playbook (shown below) playbook with your preferred text editor, then execute your chosen commands. The output from the commands should be displayed.</p>
<div class="copy-button highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Perform</span> <span class="n">an</span> <span class="n">op</span> <span class="n">command</span>
  <span class="n">paloaltonetworks</span><span class="o">.</span><span class="n">panos</span><span class="o">.</span><span class="n">panos_op</span><span class="p">:</span>
    <span class="n">provider</span><span class="p">:</span> <span class="s1">&#39;{{ device }}&#39;</span>
    <span class="n">cmd</span><span class="p">:</span> <span class="s1">&#39;command goes here&#39;</span>
  <span class="n">register</span><span class="p">:</span> <span class="n">op_command_output</span>

<span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Show</span> <span class="n">output</span>
  <span class="n">debug</span><span class="p">:</span>
    <span class="n">msg</span><span class="p">:</span>
      <span class="o">-</span> <span class="s2">&quot;{{ op_command_output }}&quot;</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../xmlapi/l300.html" class="btn btn-neutral float-left" title="3. XML API L300" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="l200.html" class="btn btn-neutral float-right" title="2. Ansible L200" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, James Holland.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>