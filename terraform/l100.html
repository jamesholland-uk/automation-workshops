<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>1. Terraform L100 &mdash; Automation Workshops  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/clipboard.min.js"></script>
        <script src="../_static/copybutton.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="2. Terraform L200" href="l200.html" />
    <link rel="prev" title="3. Ansible L300" href="../ansible/l300.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> Automation Workshops
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">PAN-OS API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../xmlapi/l100.html">1. XML API L100</a></li>
<li class="toctree-l1"><a class="reference internal" href="../xmlapi/l200.html">2. XML API L200</a></li>
<li class="toctree-l1"><a class="reference internal" href="../xmlapi/l300.html">3. XML API L300</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">PAN-OS Ansible</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../ansible/l100.html">1. Ansible L100</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ansible/l200.html">2. Ansible L200</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ansible/l300.html">3. Ansible L300</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">PAN-OS Terraform</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">1. Terraform L100</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#terraform-pre-flight-checks">1.1. Terraform pre-flight checks</a></li>
<li class="toctree-l2"><a class="reference internal" href="#download-terraform-configs">1.2. Download Terraform configs</a></li>
<li class="toctree-l2"><a class="reference internal" href="#setup-the-pan-os-variables-for-terraform">1.3. Setup the PAN-OS variables for Terraform</a></li>
<li class="toctree-l2"><a class="reference internal" href="#initialising-terraform">1.4. Initialising Terraform</a></li>
<li class="toctree-l2"><a class="reference internal" href="#the-terraform-plan">1.5. The Terraform Plan</a></li>
<li class="toctree-l2"><a class="reference internal" href="#applying-changes-with-terraform">1.6. Applying Changes with Terraform</a></li>
<li class="toctree-l2"><a class="reference internal" href="#idempotence">1.7. Idempotence</a></li>
<li class="toctree-l2"><a class="reference internal" href="#committing-and-or-pushing-changes-with-terraform">1.8. Committing and/or Pushing Changes with Terraform</a></li>
<li class="toctree-l2"><a class="reference internal" href="#applying-more-changes">1.9. Applying More Changes</a></li>
<li class="toctree-l2"><a class="reference internal" href="#getting-information-with-terraform">1.10. Getting Information with Terraform</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="l200.html">2. Terraform L200</a></li>
<li class="toctree-l1"><a class="reference internal" href="l300.html">3. Terraform L300</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Automation Workshops</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li><span class="section-number">1. </span>Terraform L100</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/terraform/l100.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="terraform-l100">
<h1><span class="section-number">1. </span>Terraform L100<a class="headerlink" href="#terraform-l100" title="Permalink to this headline"></a></h1>
<p>Hands-on tasks for this workshop will be using Ansible playbooks against a PAN-OS firewall, from your command-line environment. For each task, you can use the copy button to take the command into the clipboard, but ensure you replace any UPPERCASE_VARIABLES with your own values.</p>
<p>Assumptions: A host with the following installed: curl, git, <a class="reference external" href="https://www.terraform.io/downloads.html">Terraform 1.x</a>, and any prerequisite requirements for those items. Plus some form of text editor on your host. And, access to a PAN-OS next-generation firewall from your host.</p>
<dl class="simple">
<dt>Note:</dt><dd><ul class="simple">
<li><p>Lookout for text in uppercase, such as <code class="docutils literal notranslate"><span class="pre">YOUR_FIREWALL_IP</span></code>, and replace the text with the relevant value for your environment.</p></li>
<li><p>Commands you could/should execute are denoted with <code class="docutils literal notranslate"><span class="pre">$</span></code> at the start, and have copy buttons; other text boxes show expected outputs.</p></li>
<li><p>You may wish to have a text editor open on your machine, to amend copied commands before pasting them into the host’s CLI.</p></li>
</ul>
</dd>
</dl>
<section id="terraform-pre-flight-checks">
<h2><span class="section-number">1.1. </span>Terraform pre-flight checks<a class="headerlink" href="#terraform-pre-flight-checks" title="Permalink to this headline"></a></h2>
<p>First let’s check that Terraform is installed on our host.</p>
<div class="copy-button highlight-default notranslate"><div class="highlight"><pre><span></span>$ terraform -version
</pre></div>
</div>
<p>The output should look something like this, and may contain a warning if you are not on the very latest version:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Terraform v1.0.10

Your version of Terraform is out of date! The latest version
is 1.1.0. You can update by downloading from https://www.terraform.io/downloads.html
</pre></div>
</div>
<p>It is fine to ignore the warning, as long as your version is at least 1.0.0 or higher.</p>
</section>
<section id="download-terraform-configs">
<h2><span class="section-number">1.2. </span>Download Terraform configs<a class="headerlink" href="#download-terraform-configs" title="Permalink to this headline"></a></h2>
<p>In this workshop, we’re going to be using some existing Terraform configs. We’ll use git to download them from a repository…</p>
<div class="copy-button highlight-default notranslate"><div class="highlight"><pre><span></span>$ git clone https://github.com/jamesholland-uk/automation-workshops.git
</pre></div>
</div>
<p>…then move into the Terraform directory</p>
<div class="copy-button highlight-default notranslate"><div class="highlight"><pre><span></span>$ cd automation-workshops/terraform
</pre></div>
</div>
<p>In the Terraform directory, a number of files will be present:</p>
<div class="copy-button highlight-default notranslate"><div class="highlight"><pre><span></span>$ ls -l
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">00.</span><span class="n">tf</span>               \
<span class="mf">01.</span><span class="n">tf</span><span class="o">.</span><span class="n">bak</span>            <span class="o">|-</span> <span class="n">These</span> <span class="n">are</span> <span class="n">the</span> <span class="n">files</span> <span class="n">where</span> <span class="n">we</span>
<span class="mf">02.</span><span class="n">tf</span><span class="o">.</span><span class="n">bak</span>            <span class="o">|-</span> <span class="n">write</span> <span class="n">our</span> <span class="n">Terraform</span> <span class="n">code</span>
<span class="mf">03.</span><span class="n">tf</span><span class="o">.</span><span class="n">bak</span>           <span class="o">/</span>
<span class="n">commit</span><span class="o">.</span><span class="n">sh</span>             <span class="o">-</span> <span class="n">We</span> <span class="n">will</span> <span class="n">use</span> <span class="n">this</span> <span class="n">script</span> <span class="n">to</span> <span class="n">perform</span> <span class="n">a</span> <span class="n">commit</span> <span class="n">after</span> <span class="n">making</span> <span class="n">changes</span>
<span class="n">providers</span><span class="o">.</span><span class="n">tf</span>          <span class="o">-</span> <span class="n">This</span> <span class="n">file</span> <span class="n">describes</span> <span class="n">the</span> <span class="n">third</span> <span class="n">party</span> <span class="n">systems</span><span class="p">,</span> <span class="n">such</span> <span class="k">as</span> <span class="n">PAN</span><span class="o">-</span><span class="n">OS</span><span class="p">,</span> <span class="n">which</span> <span class="n">we</span> <span class="n">want</span> <span class="n">to</span> <span class="n">use</span>
<span class="n">variables</span><span class="o">.</span><span class="n">tf</span>          <span class="o">-</span> <span class="n">This</span> <span class="n">file</span> <span class="n">defines</span> <span class="n">the</span> <span class="n">variables</span> <span class="n">we</span> <span class="n">are</span> <span class="n">going</span> <span class="n">to</span> <span class="n">use</span> <span class="ow">in</span> <span class="n">our</span> <span class="n">Terraform</span> <span class="n">code</span>
</pre></div>
</div>
</section>
<section id="setup-the-pan-os-variables-for-terraform">
<h2><span class="section-number">1.3. </span>Setup the PAN-OS variables for Terraform<a class="headerlink" href="#setup-the-pan-os-variables-for-terraform" title="Permalink to this headline"></a></h2>
<p>Terraform needs to know the details for the hosts against which it should execute. There are a variety of methods for this, today we will store the host, admin username and admin password as variables:</p>
<div class="copy-button highlight-default notranslate"><div class="highlight"><pre><span></span>$ export TF_VAR_panos_hostname=&quot;YOUR_FIREWALL_IP&quot;
$ export TF_VAR_panos_username=&quot;YOUR_ADMIN_USERNAME&quot;
$ export TF_VAR_panos_password=&quot;YOUR_ADMIN_PASSWORD&quot;
</pre></div>
</div>
<p>For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ export TF_VAR_panos_hostname=&quot;10.10.10.10&quot;
$ export TF_VAR_panos_username=&quot;adminuser&quot;
$ export TF_VAR_panos_password=&quot;ChangeMe123!&quot;
</pre></div>
</div>
<p>In production environments, credentials should be stored, accessed and used securely, per the security policy and compliance requirements. Today, in this environment, we will use these credentials stored in variables for executing Ansible playbooks.</p>
</section>
<section id="initialising-terraform">
<h2><span class="section-number">1.4. </span>Initialising Terraform<a class="headerlink" href="#initialising-terraform" title="Permalink to this headline"></a></h2>
<p>Terraform uses a multi-stage process, the first of which is to <code class="docutils literal notranslate"><span class="pre">init</span></code>, short for <a class="reference external" href="https://www.terraform.io/docs/cli/commands/init.html">initialise</a>. Run the following command, which sets up the directory Terraform works with (.terraform/), as well as downloading various required files ready to be used at runtime.</p>
<div class="copy-button highlight-default notranslate"><div class="highlight"><pre><span></span>$ terraform init
</pre></div>
</div>
<p>The output should look something like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Initializing the backend...

Initializing provider plugins...
<span class="hll">- Finding paloaltonetworks/panos versions matching &quot;~&gt; 1.8.3&quot;...
</span><span class="hll">- Installing paloaltonetworks/panos v1.8.3...
</span><span class="hll">- Installed paloaltonetworks/panos v1.8.3 (signed by a HashiCorp partner, key ID D5D93F98EFA33E83)
</span>
Partner and community providers are signed by their developers.
If you&#39;d like to know more about provider signing, you can read about it here:
https://www.terraform.io/docs/plugins/signing.html

Terraform has created a lock file .terraform.lock.hcl to record the provider
selections it made above. Include this file in your version control repository
so that Terraform can guarantee to make the same selections by default when
you run &quot;terraform init&quot; in the future.

<span class="hll">Terraform has been successfully initialized!
</span>
You may now begin working with Terraform. Try running &quot;terraform plan&quot; to see
any changes that are required for your infrastructure. All Terraform commands
should now work.

If you ever set or change modules or backend configuration for Terraform,
rerun this command to reinitialize your working directory. If you forget, other
commands will detect it and remind you to do so if necessary.
</pre></div>
</div>
<p>Some particularly interesting lines in the output are the first block of highlighted text, showing the download of the PAN-OS <code class="docutils literal notranslate"><span class="pre">provider</span></code>. A provider is responsible for the interaction between Terraform and a remote system, in this case a PAN-OS firewalls. Providers are available for many other prducts and cloud services.</p>
<p>Also of note is the second section of highlighted text, confirming Terraform has been successfully initialised.</p>
</section>
<section id="the-terraform-plan">
<h2><span class="section-number">1.5. </span>The Terraform Plan<a class="headerlink" href="#the-terraform-plan" title="Permalink to this headline"></a></h2>
<p>The second stage when using Terraform is usually <code class="docutils literal notranslate"><span class="pre">plan</span></code>, which as you may expect, asks Terraform to plan what it will do next. Given the resources you are asking Terraform to work with, which could be anything from cloud infrastructure to PAN-OS firewalls, Terraform will first assess the real state of those resources. Terraform will then compare that real state with your desired state, which is defined by Terraform configuration files (those files in the local directory with .tf extension), and show you the difference between the two. This therefore describes the alterations which Terraform would make the next time it is executed to <code class="docutils literal notranslate"><span class="pre">apply</span></code> changes, to change the real state into the desired state.</p>
<p>Let’s look at our current Terraform config file. Ignoring the providers.tf and variables.tf files for now, the remaining .tf file in scope right now is 00.tf, use this command to show that file’s contents:</p>
<div class="copy-button highlight-default notranslate"><div class="highlight"><pre><span></span>$ cat 00.tf
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">resource</span> <span class="s2">&quot;panos_address_object&quot;</span> <span class="s2">&quot;terraform-address-object-1&quot;</span> <span class="p">{</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;terraform-address-object-1&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;192.168.80.1/32&quot;</span>
        <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;Address object 1 from Terraform&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Note that convention is to name the file with your configuration <code class="docutils literal notranslate"><span class="pre">main.tf</span></code>, but it could be called anything. We have several exercises, so we are using <code class="docutils literal notranslate"><span class="pre">00.tf</span></code>, <code class="docutils literal notranslate"><span class="pre">01.tf</span></code>, <code class="docutils literal notranslate"><span class="pre">02.tf</span></code>, etc</p>
<p>The file 00.tf defines a single resource, an address object called <code class="docutils literal notranslate"><span class="pre">terraform-address-object-1</span></code> with value <code class="docutils literal notranslate"><span class="pre">192.168.80.1/32</span></code>. By logging into your firewall’s web GUI or CLI, you will see there are no address objects configured at present.</p>
<p>Now, let’s run the following command to ask Terraform to show the plan:</p>
<div class="copy-button highlight-default notranslate"><div class="highlight"><pre><span></span>$ terraform plan
</pre></div>
</div>
<p>The output should look something like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:
  + create

Terraform will perform the following actions:

# panos_address_object.terraform-address-object-1 will be created
+ resource &quot;panos_address_object&quot; &quot;terraform-address-object-1&quot; {
    + description  = &quot;Address object 1 from Terraform&quot;
    + device_group = &quot;shared&quot;
    + id           = (known after apply)
    + name         = &quot;terraform-address-object-1&quot;
    + type         = &quot;ip-netmask&quot;
    + value        = &quot;192.168.80.1/32&quot;
    + vsys         = &quot;vsys1&quot;
}

Plan: 1 to add, 0 to change, 0 to destroy.

───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────

Note: You didn&#39;t use the -out option to save this plan, so Terraform can&#39;t guarantee to take exactly these actions if you run &quot;terraform apply&quot; now.
</pre></div>
</div>
<p>As expected, the plan (which remember is the difference between the real state and the desired state) will add a single address object.</p>
</section>
<section id="applying-changes-with-terraform">
<h2><span class="section-number">1.6. </span>Applying Changes with Terraform<a class="headerlink" href="#applying-changes-with-terraform" title="Permalink to this headline"></a></h2>
<p>As previously mentioned, Terraform wants to use all .tf files in the local directory, so lets remove the first file from scope, and introduce the second file:</p>
<div class="copy-button highlight-default notranslate"><div class="highlight"><pre><span></span>$ mv 00.tf 00.tf.bak
$ mv 01.tf.bak 01.tf
</pre></div>
</div>
<p>The second Terraform file creates more address objects and a creates an address group:</p>
<div class="copy-button highlight-default notranslate"><div class="highlight"><pre><span></span>$ cat 01.tf
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">resource</span> <span class="s2">&quot;panos_address_group&quot;</span> <span class="s2">&quot;terraform-address-group&quot;</span> <span class="p">{</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;terraform-address-group&quot;</span>
        <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;Group of internal hosts&quot;</span>
        <span class="n">static_addresses</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">panos_address_object</span><span class="o">.</span><span class="n">terraform</span><span class="o">-</span><span class="n">address</span><span class="o">-</span><span class="nb">object</span><span class="o">-</span><span class="mf">1.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">panos_address_object</span><span class="o">.</span><span class="n">terraform</span><span class="o">-</span><span class="n">address</span><span class="o">-</span><span class="nb">object</span><span class="o">-</span><span class="mf">2.</span><span class="n">name</span>
        <span class="p">]</span>
<span class="p">}</span>

<span class="n">resource</span> <span class="s2">&quot;panos_address_object&quot;</span> <span class="s2">&quot;terraform-address-object-1&quot;</span> <span class="p">{</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;terraform-address-object-1&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;192.168.80.1/32&quot;</span>
        <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;Address object 1 from Terraform&quot;</span>
<span class="p">}</span>

<span class="n">resource</span> <span class="s2">&quot;panos_address_object&quot;</span> <span class="s2">&quot;terraform-address-object-2&quot;</span> <span class="p">{</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;terraform-address-object-2&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;192.168.80.2/32&quot;</span>
        <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;Address object 2 from Terraform&quot;</span>
<span class="p">}</span>

<span class="n">resource</span> <span class="s2">&quot;panos_address_object&quot;</span> <span class="s2">&quot;terraform-address-object-3&quot;</span> <span class="p">{</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;terraform-address-object-3&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;192.168.80.3/32&quot;</span>
        <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;Address object 3 from Terraform&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Perform the <code class="docutils literal notranslate"><span class="pre">terraform</span> <span class="pre">plan</span></code> command to test run the changes:</p>
<div class="copy-button highlight-default notranslate"><div class="highlight"><pre><span></span>$ terraform plan
</pre></div>
</div>
<p>The output should look something like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:
  + create

Terraform will perform the following actions:

<span class="hll"># panos_address_group.terraform-address-group will be created
</span>+ resource &quot;panos_address_group&quot; &quot;terraform-address-group&quot; {
        + id               = (known after apply)
        + name             = &quot;terraform-address-group&quot;
        + static_addresses = [
                + &quot;terraform-address-object-1&quot;,
                + &quot;terraform-address-object-2&quot;,
                ]
        + vsys             = &quot;vsys1&quot;
}

<span class="hll"># panos_address_object.terraform-address-object-1 will be created
</span>+ resource &quot;panos_address_object&quot; &quot;terraform-address-object-1&quot; {
        + description  = &quot;Address object 1 from Terraform&quot;
        + device_group = &quot;shared&quot;
        + id           = (known after apply)
        + name         = &quot;terraform-address-object-1&quot;
        + type         = &quot;ip-netmask&quot;
        + value        = &quot;192.168.80.1/32&quot;
        + vsys         = &quot;vsys1&quot;
}

<span class="hll"># panos_address_object.terraform-address-object-2 will be created
</span>+ resource &quot;panos_address_object&quot; &quot;terraform-address-object-2&quot; {
        + description  = &quot;Address object 2 from Terraform&quot;
        + device_group = &quot;shared&quot;
        + id           = (known after apply)
        + name         = &quot;terraform-address-object-2&quot;
        + type         = &quot;ip-netmask&quot;
        + value        = &quot;192.168.80.2/32&quot;
        + vsys         = &quot;vsys1&quot;
}

<span class="hll"># panos_address_object.terraform-address-object-3 will be created
</span>+ resource &quot;panos_address_object&quot; &quot;terraform-address-object-3&quot; {
        + description  = &quot;Address object 3 from Terraform&quot;
        + device_group = &quot;shared&quot;
        + id           = (known after apply)
        + name         = &quot;terraform-address-object-3&quot;
        + type         = &quot;ip-netmask&quot;
        + value        = &quot;192.168.80.3/32&quot;
        + vsys         = &quot;vsys1&quot;
}

<span class="hll">Plan: 4 to add, 0 to change, 0 to destroy.
</span>
───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────

Note: You didn&#39;t use the -out option to save this plan, so Terraform can&#39;t guarantee to take exactly these actions if you run &quot;terraform apply&quot; now.
</pre></div>
</div>
<p>Each of the first four highlighted sections show a new object being created for our firewall. The final highlighted section gives a summary, telling us 4 new objects will be created, none to be modified, none to be destroyed. By logging into the firewall web GUI, you should be able to observe that these objects do not already exist.</p>
<p>To make these changes on the firewall, we use the <code class="docutils literal notranslate"><span class="pre">terraform</span> <span class="pre">apply</span></code> command. It is performed like this:</p>
<div class="copy-button highlight-default notranslate"><div class="highlight"><pre><span></span>$ terraform apply
</pre></div>
</div>
<p>The plan will be re-generated, and you will be asked for confirmation to make the changes, so type <code class="docutils literal notranslate"><span class="pre">yes</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Do you want to perform these actions?
Terraform will perform the actions described above.
Only &#39;yes&#39; will be accepted to approve.

<span class="hll">Enter a value: yes
</span></pre></div>
</div>
<p>Our address objects and group are now created in the candidate configuration. This can be confirmed by observing the web GUI for the firewall.</p>
<p>Note that in the <code class="docutils literal notranslate"><span class="pre">plan</span></code> output, as in the configuration file, the address group was listed first before the address objects. Terraform executes in the order which observes any dependencies, and hence during the <code class="docutils literal notranslate"><span class="pre">apply</span></code> operation, it created the address objects first, then added them to the group (as adding non-existent address objects to an address group would have failed in PAN-OS).</p>
</section>
<section id="idempotence">
<h2><span class="section-number">1.7. </span>Idempotence<a class="headerlink" href="#idempotence" title="Permalink to this headline"></a></h2>
<p>Note that at this point, you should be able to perform <code class="docutils literal notranslate"><span class="pre">terraform</span> <span class="pre">apply</span></code> multiple times, and because Terraform and the PAN-OS provider perform idempotent operations, no changes will be made. Idempotence calls for operations that can be applied multiple times without changing the result, and in this context, duplicate objects will not be created each time <code class="docutils literal notranslate"><span class="pre">terraform</span> <span class="pre">apply</span></code> is executed, the output should just end with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Apply complete! Resources: 0 added, 0 changed, 0 destroyed.
</pre></div>
</div>
</section>
<section id="committing-and-or-pushing-changes-with-terraform">
<h2><span class="section-number">1.8. </span>Committing and/or Pushing Changes with Terraform<a class="headerlink" href="#committing-and-or-pushing-changes-with-terraform" title="Permalink to this headline"></a></h2>
<p><strong>IMPORTANT</strong>: Terraform’s methodology is to expect that when configuration changes are executed with the <code class="docutils literal notranslate"><span class="pre">terraform</span> <span class="pre">plan</span></code> command, each configuration item is made live straight away. PAN-OS works differently, where configuration can (and some times has to be) be built up across objects, rules, zones, interfaces and more, and the configuration is only valid once all the parts are in place. All the various parts of configuration are then made live with a <code class="docutils literal notranslate"><span class="pre">commit</span></code> operation. This difference in methodology between Terraform and PAN-OS requires <a class="reference external" href="https://registry.terraform.io/providers/PaloAltoNetworks/panos/latest/docs/guides/commits-overview">commits to be performed via a specific mechanism</a>; there are a variety of approaches to performing PAN-OS commits with Terraform, today we will use a simple script:</p>
<div class="copy-button highlight-default notranslate"><div class="highlight"><pre><span></span>$ ./commit.sh $TF_VAR_panos_hostname $TF_VAR_panos_username $TF_VAR_panos_password
</pre></div>
</div>
<p>The script will initiate a commit, and wait through the active (<code class="docutils literal notranslate"><span class="pre">ACT</span></code>) stage, until it is finished (<code class="docutils literal notranslate"><span class="pre">FIN</span></code>).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>./commit.sh $TF_VAR_panos_hostname $TF_VAR_panos_username $TF_VAR_panos_password
Commit status: ACT
Commit status: ACT
Commit status: ACT
Commit status: ACT
Commit status: ACT
Commit status: ACT
Commit status: ACT
Final commit status: FIN
</pre></div>
</div>
<p>The changes are now live in the running configuration.</p>
</section>
<section id="applying-more-changes">
<h2><span class="section-number">1.9. </span>Applying More Changes<a class="headerlink" href="#applying-more-changes" title="Permalink to this headline"></a></h2>
<p>Let’s make some more changes. We will use the third Terraform file for this, so execute the commands below:</p>
<div class="copy-button highlight-default notranslate"><div class="highlight"><pre><span></span>$ mv 01.tf 01.tf.bak
$ mv 02.tf.bak 02.tf
</pre></div>
</div>
<p>You can view the next config file with this command:</p>
<div class="copy-button highlight-default notranslate"><div class="highlight"><pre><span></span>$ cat 02.tf
</pre></div>
</div>
<p>The changes between the last config file and this file include: the absence of address-object-3, a description being added to the existing address group, and the addition of two zones and two security rules.</p>
<p>Run <code class="docutils literal notranslate"><span class="pre">terraform</span> <span class="pre">plan</span></code> to see what changes Terraform is lining up:</p>
<div class="copy-button highlight-default notranslate"><div class="highlight"><pre><span></span>$ terraform plan
</pre></div>
</div>
<p>Because this Terraform file includes only two of the objects previously created, one address object is listed for deletion; that object has been removed from the config file and hence been removed from the desired state in Terraform’s eyes. This is important in understanding how Terraform deals with state, and mapping the desired state listed in the config file to the real world state.</p>
<p>The output should be something like this (truncated for brevity):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Terraform</span> <span class="n">will</span> <span class="n">perform</span> <span class="n">the</span> <span class="n">following</span> <span class="n">actions</span><span class="p">:</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="hll">  <span class="c1"># panos_address_group.terraform-address-group will be updated in-place</span>
</span><span class="hll">  <span class="o">~</span> <span class="n">resource</span> <span class="s2">&quot;panos_address_group&quot;</span> <span class="s2">&quot;terraform-address-group&quot;</span> <span class="p">{</span>
</span><span class="hll">      <span class="o">+</span> <span class="n">description</span>      <span class="o">=</span> <span class="s2">&quot;Group of internal hosts&quot;</span>
</span><span class="o">.</span>
<span class="o">.</span>
<span class="hll">  <span class="c1"># panos_address_object.terraform-address-object-3 will be destroyed</span>
</span><span class="hll">  <span class="c1"># (because panos_address_object.terraform-address-object-3 is not in configuration)</span>
</span><span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="hll"><span class="n">Plan</span><span class="p">:</span> <span class="mi">3</span> <span class="n">to</span> <span class="n">add</span><span class="p">,</span> <span class="mi">1</span> <span class="n">to</span> <span class="n">change</span><span class="p">,</span> <span class="mi">1</span> <span class="n">to</span> <span class="n">destroy</span><span class="o">.</span>
</span></pre></div>
</div>
<p>Note the modification of the address group (adding a description), the removal of address-object-3, and the addition of two zones and some security rules.</p>
<p>Make these changes to the firewall, using <code class="docutils literal notranslate"><span class="pre">terraform</span> <span class="pre">apply</span></code> command, but this time we can skip the confirmation prompt like this:</p>
<div class="copy-button highlight-default notranslate"><div class="highlight"><pre><span></span>$ terraform apply --auto-approve
</pre></div>
</div>
<p>Finally, execute the commit script, and confirm the new zones and rules are live on the firewall’s running configuration bia the web GUI:</p>
<div class="copy-button highlight-default notranslate"><div class="highlight"><pre><span></span>$ ./commit.sh $TF_VAR_panos_hostname $TF_VAR_panos_username $TF_VAR_panos_password
</pre></div>
</div>
</section>
<section id="getting-information-with-terraform">
<h2><span class="section-number">1.10. </span>Getting Information with Terraform<a class="headerlink" href="#getting-information-with-terraform" title="Permalink to this headline"></a></h2>
<p>The next exercise will show that Terraform can gather PAN-OS state information when required. This uses a <code class="docutils literal notranslate"><span class="pre">data</span> <span class="pre">source</span></code>, the part of a Terraform provider responsible for gathering data. Switch to this Terraform file, then observe the new lines in this Terraform file, with these commands:</p>
<div class="copy-button highlight-default notranslate"><div class="highlight"><pre><span></span>$ mv 02.tf 02.tf.bak
$ mv 03.tf.bak 03.tf
</pre></div>
</div>
<div class="copy-button highlight-default notranslate"><div class="highlight"><pre><span></span>$ diff 02.tf.bak 03.tf
</pre></div>
</div>
<p>The output from <code class="docutils literal notranslate"><span class="pre">diff</span></code> shows we have added some extra lines from the previous exercise:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">---</span>
<span class="o">&gt;</span> <span class="p">}</span>
<span class="o">&gt;</span>
<span class="hll"><span class="o">&gt;</span> <span class="n">data</span> <span class="s2">&quot;panos_system_info&quot;</span> <span class="s2">&quot;ngfw_info&quot;</span> <span class="p">{</span> <span class="p">}</span>
</span><span class="o">&gt;</span>
<span class="hll"><span class="o">&gt;</span> <span class="n">output</span> <span class="s2">&quot;the_info&quot;</span> <span class="p">{</span>
</span><span class="hll"><span class="o">&gt;</span>     <span class="n">value</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">panos_system_info</span><span class="o">.</span><span class="n">ngfw_info</span>
</span><span class="o">&gt;</span> <span class="p">}</span>
</pre></div>
</div>
<p>We are using the <a class="reference external" href="https://registry.terraform.io/providers/PaloAltoNetworks/panos/latest/docs/data-sources/system_info">panos_system_info</a> data source to mimic a <code class="docutils literal notranslate"><span class="pre">show</span> <span class="pre">system</span> <span class="pre">info</span></code> on the CLI. The <code class="docutils literal notranslate"><span class="pre">data</span></code> line instructs Terraform to collect the data, and the <code class="docutils literal notranslate"><span class="pre">output</span></code> lines instruct Terraform to send the data out at the end of running tasks. Let’s gather the data, by again using the <code class="docutils literal notranslate"><span class="pre">plan</span></code> command:</p>
<div class="copy-button highlight-default notranslate"><div class="highlight"><pre><span></span>$ terraform plan
</pre></div>
</div>
<p>The output should look something like this (truncated for brevity):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Changes</span> <span class="n">to</span> <span class="n">Outputs</span><span class="p">:</span>
<span class="o">+</span> <span class="n">the_info</span> <span class="o">=</span> <span class="p">{</span>
    <span class="o">+</span> <span class="nb">id</span>            <span class="o">=</span> <span class="s2">&quot;10.110.255.4&quot;</span>
    <span class="o">+</span> <span class="n">info</span>          <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;app-version&quot;</span> <span class="o">=</span> <span class="s2">&quot;8468-6979&quot;</span>
        <span class="s2">&quot;av-version&quot;</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span>
        <span class="s2">&quot;cloud-mode&quot;</span> <span class="o">=</span> <span class="s2">&quot;cloud&quot;</span>
        <span class="s2">&quot;default-gateway&quot;</span> <span class="o">=</span> <span class="s2">&quot;10.110.255.1&quot;</span>
        <span class="s2">&quot;device-certificate-status&quot;</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span>
        <span class="s2">&quot;device-dictionary-version&quot;</span> <span class="o">=</span> <span class="s2">&quot;1-211&quot;</span>
        <span class="s2">&quot;devicename&quot;</span> <span class="o">=</span> <span class="s2">&quot;lab-fw&quot;</span>
        <span class="s2">&quot;family&quot;</span> <span class="o">=</span> <span class="s2">&quot;vm&quot;</span>
        <span class="o">.</span>
        <span class="o">.</span>
        <span class="o">.</span>
        <span class="s2">&quot;wildfire-rt&quot;</span> <span class="o">=</span> <span class="s2">&quot;Disabled&quot;</span>
        <span class="s2">&quot;wildfire-version&quot;</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span>
        <span class="p">}</span>
    <span class="o">+</span> <span class="n">version_major</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="o">+</span> <span class="n">version_minor</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="o">+</span> <span class="n">version_patch</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="p">}</span>
</pre></div>
</div>
<p>The first block is the equivalent output from the CLI command <code class="docutils literal notranslate"><span class="pre">show</span> <span class="pre">system</span> <span class="pre">info</span></code>, followed by the PAN-OS version broken down by major, minor and patch version.</p>
<p>This can be useful on its own, but the information could also be parsed and used in other areas of our Terraform logic, where we might choose to perform a tasks if the PAN-OS software is equal to or greater than a certain version number.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../ansible/l300.html" class="btn btn-neutral float-left" title="3. Ansible L300" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="l200.html" class="btn btn-neutral float-right" title="2. Terraform L200" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, James Holland.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>